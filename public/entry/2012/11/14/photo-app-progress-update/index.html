
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Photo App Progress Update - mlindgren.ca</title>
  <meta name="author" content="Mitch Lindgren">

  
  <meta name="description" content="In September I wrote about
my intention to develop a web application to share my photos. I made good
progress on it throughout September and early &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.mlindgren.ca/entry/2012/11/14/photo-app-progress-update/">
  <link href="/favicon.ico" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="mlindgren.ca" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700" rel="stylesheet" type="text/css">

<!--
/* @license
* MyFonts Webfont Build ID 1737828, 2011-12-16T22:03:39-0500
*
* The fonts listed in this notice are subject to the End User License
* Agreement(s) entered into by the website owner. All other parties are 
* explicitly restricted from using the Licensed Webfonts(s).
*
* You may obtain a valid license at the URLs below.
*
* Webfont: Museo 700 by exljbris
* URL: http://www.myfonts.com/fonts/exljbris/museo/700/
* Copyright: Copyright (c) 2008 by Jos Buivenga/exljbris. All rights reserved.
* Licensed pageviews: unlimited
*
*
* License: http://www.myfonts.com/viewlicense?type=web&buildid=1737828
*
* Â© 2011 Bitstream Inc
*/

-->
<link rel="stylesheet" type="text/css" href="/stylesheets/mlindgren_ca_museo700.css">

<!-- Load jQuery -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"
type="text/javascript"></script>
<script type="text/javascript">
    jQuery.noConflict(); // ender.js conflicts with jQuery
</script>

 <!-- Load FancyBox -->
 <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" />
 <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript">
 </script>

<!-- Fix FancyBox style for OctoPress -->
<style type="text/css">
  .fancybox-wrap { position: fixed !important; }
  .fancybox-opened {
    -webkit-border-radius: 4px !important;
       -moz-border-radius: 4px !important;
            border-radius: 4px !important;
  }
  .fancybox-close, .fancybox-prev span, .fancybox-next span {
    background-color: transparent !important;
    border: 0 !important;
  }
</style>


<!-- Custom Scripts -->
<script language="Javascript" type="text/javascript">
// ender.js gobbles jQuery's ready event: Use ender.js $ instead
$(document).ready(function() {
    jQuery(".fancybox").fancybox(
    {
      helpers:
      {
        overlay:
        {
          locked: false
        }
      }
    });
});
</script>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">mlindgren.ca</a></h1>
  
</hgroup>
<div id="header-outer-wrap">
  <div id="header-wrap">
    <div id="header-background">
      <img src="/images/header.jpg" class="header-background-stretch" />
    </div>
  </div>
</div>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:blog.mlindgren.ca" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      

<div id="category-wrapper" class="category-Coding">
<article class="hentry " role="article">
  

<div class="category-Coding">

  <header>
    
      <h1 class="entry-title"><a href="#">Photo App Progress Update</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-11-14T22:58:00-08:00" pubdate data-updated="true">Nov 14<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>In September I <a href="/entry/2012/09/14/social-networks-and-content-ownership/">wrote about</a>
my intention to develop a web application to share my photos. I made good
progress on it throughout September and early October, but for various reasons I
haven&rsquo;t been able to work on it much in the past month or so. Last weekend,
though, I was able to solve some blocking issues which were preventing me from
doing an alpha release. Those being dealt with, I&rsquo;ve now got a few of my albums
up at <a href="http://photos.mlindgren.ca/">photos.mlindgren.ca</a>; take a look and leave
a comment if you have any feedback.</p>

<p>I haven&rsquo;t released the source code yet as there&rsquo;s still a great deal of work to
be done, and I&rsquo;m generally of the belief that dumping a bunch of unfinished,
messy code on Github with the hope that the community will sort it out is of
little benefit to anyone. My goal at this point is to do a beta release in a
two to three months or so and release the code at that point. That timeline is
anything but firm, though. This project is turning out to be much more work than
I expected (as projects are wont to do), and I expect to be fairly busy over the
next couple months.</p>

<p>Anyway, with the alpha version up and running, this seems like a good
opportunity to reflect on some of the issues I&rsquo;ve faced that complicated the
project, and on what remains to be done. <!-- more --></p>

<h2>Wand and the OOM Killer</h2>

<p>I mentioned in my
<a href="/entry/2012/09/14/the-state-of-python-imaging/">post on Python imaging libraries</a>
that I&rsquo;m using <a href="http://dahlia.kr/wand/index.html">Wand</a> to resize and transform
uploaded photos. It&rsquo;s very convenient and easy to use, and from a
maintainability and ease of use perspective I much prefer using Python bindings
for ImageMagick to shelling out to the ImageMagick executable. One
of my goals for this project is that other people should be able to install it
on their own servers with relative ease, and I suspect relying on ImageMagick
executables for image processing would lead to cross-platform and configuration
issues.</p>

<p>But, Wand is not yet a mature library and it has some significant issues of its
own. First and foremost, when I started using it it had some major memory
leaks. I found and fixed more than 10 leaks and submitted a pull request which
was merged into the main repository&mdash;however, there hasn&rsquo;t yet been an
official release including my fixes yet, so pip installs and downloads from the
Wand website will still include those leaks.</p>

<p>I&rsquo;m not sure if I got all of the leaks or if more still remain. The ones I fixed
were discovered mostly through ad-hoc testing and reading the code. I&rsquo;ve been
running my app for several days now and the memory consumption when it&rsquo;s idle
has stayed flat, so I believe I&rsquo;ve removed at least the most common leaks, but I
haven&rsquo;t had a chance to sit down with Valgrind yet and run the Wand unit tests
through it to make sure that I got <em>all</em> of the leaks. I&rsquo;ll have to do that
before I do any sort of public release of my software;
I don&rsquo;t want to rely on a leaky library.</p>

<p>Beyond the leaks, I ran into another memory issue which proved problematic:
resizing photographs can use a great deal of memory, which is extremely limited
on a reasonably-priced <acronym title="Virtual Private Server">VPS</acronym>.
I have limited knowledge about image processing in general and ImageMagick in
particular, but I&rsquo;m not aware of any resizing algorithms which can operate
directly on compressed image data, and if any such algorithms exist, ImageMagick
doesn&rsquo;t use them. That being the case, to resize an image, the entire image has
to be loaded into memory decompressed. For an 8 megapixel photograph at 24 bits
per pixel, that means allocating approximately 183MB of memory.</p>

<p>On a 512MB VPS, this means that trying to resize three images
concurrently&mdash;or even sequentially in some cases, since Python isn&rsquo;t
guaranteed to immediately relinquish allocated memory to the operating system
when objects resident in that memory are &ldquo;deleted&rdquo;&mdash;practically guarantees
that the process will be killed by the
<acronym title="Out Of Memory">OOM</acronym> killer.</p>

<p>This goes hand in hand with another complication, which is that resizing images
is too slow to be done in the same server thread that&rsquo;s handling requests and
generating responses. For each image that&rsquo;s uploaded, I save several different
sizes for different purposes, and due to the aforementioned memory constraints I
can&rsquo;t even resize them concurrently. Resizing each image several times in the
responding thread drastically reduces throughput for the client
since it incurs a significant wait time for the server to process each image
after it&rsquo;s uploaded.</p>

<h2>Enter Subprocess</h2>

<p>So here&rsquo;s the solution I&rsquo;ve come up with for the time being, and I&rsquo;m very unsure
whether or not it&rsquo;s actually a good solution, so please do let me know in the
comments if there&rsquo;s a better way to do this.  When a new image is uploaded, the
responding thread saves the image in the appropriate directory and adds it to
the database, but does not resize it.  For each of the sizes that the image
needs to be resized to, it adds a task to a
<a href="http://docs.python.org/2/library/queue.html">synchronous queue</a>. The queue is
consumed by a different thread which runs throughout the lifetime of the
application. That thread maintains a (thread-local) queue of
<a href="http://docs.python.org/2/library/multiprocessing.html">subprocesses</a> with a
configurable maximum length. When a new resizing task is consumed, if there is
room in the subprocess queue, a new subprocess is spawned to resize the image.
Otherwise, the thread joins the subprocess at the front of the queue so as to
block until there&rsquo;s room to spawn a new subprocess. The exit code of completed
processes is checked to ensure that the resize was successful; in case of
failure, the task is re-added to the back of the task queue.</p>

<p>This guarantees that the application server itself will never be killed by the
OOM killer since it uses minimal memory. It never has to load images into
memory; all of that is done in the resizing subprocesses.  By configuring the
maximum number of concurrent subprocesses, one can scale this solution according
to available resources: if you have plenty of RAM, you can resize many images
concurrently and get through the queue faster, or if you have very little, you
can limit the queue to one or two processes to minimize the chance that anything
will be OOM killed.</p>

<p>The subprocess spawning notwithstanding, this is a pretty standard task queue
model, so you might be wondering why I didn&rsquo;t use something like
<a href="http://celeryproject.org/">Celery</a> in conjunction with a real message queue.
It comes down to minimizing the number of external dependencies and maximizing
ease of use. My project already depends on a number of libraries which will have
to be installed by users. To the greatest extent that I can do so without
compromising on features, I want to avoid complicating the installation further
by adding more dependencies. Celery is particularly difficult to install as it
requires installing and configuring a broker and managing processes for both the
broker and Celery itself. Were I writing a large-scale service and maintaining a
single backend for hundreds of users, it would probably be the right choice, but
as I am writing software for users to install on their own servers, it is
probably not.</p>

<p>This method works fairly well and it&rsquo;s the best I&rsquo;ve come up with so far, but
something about it makes it feel more like a hack than a well thought out and
robust solution. I also wonder if it defeats the purpose of using Wand in the
first place; I use it for very little other than resizing, and since I&rsquo;m going
to the trouble of spawning subprocesses to do that, perhaps it would actually be
better to just directly invoke the ImageMagick binaries. As mentioned above, I
have concerns about what impact that would have in different environments, but I
haven&rsquo;t really validated those concerns; they&rsquo;re just hunches.</p>

<h2>The Road Ahead</h2>

<p>So I&rsquo;ve got a workable, if not perfect, solution to one of the biggest problems
I encountered&hellip; but as I mentioned previously, there&rsquo;s still much work to be
done. Here are a few (but not all) of the things I&rsquo;d like to do before I release
anything publicly:</p>

<ul>
<li><strong>Lots of UI work.</strong> Right now the app works very poorly on phones and iPads.
I also need to figure out how to make certain features more discoverable, and
although I&rsquo;m happy with how albums look right now, there are still some extra
touches that I want to add which I haven&rsquo;t yet been able to (because CSS and
HTML suck.)</li>
<li><strong>Better administrative tools.</strong> Uploading works great, but I have very
barebones interfaces for editing albums right now. There is currently no means
of rotating a photo from the editing interface (although doing so should
almost never be necessary since the app automatically rotates images which
have EXIF orientation data.)</li>
<li><strong>Mirroring and proxying to cloud storage services</strong> such as Azure and S3. VPS
resources are very expensive; extra disk space on some popular hosts runs
around a dollar per gigabyte per month. That&rsquo;s ten times the cost of disk
space on the cloud storage services I&rsquo;ve looked at. Cloud-hosted images might
also improve load speeds for visitors.</li>
<li><strong>Comments.</strong> This one is pretty big, obviously, but I haven&rsquo;t added it yet
because I can&rsquo;t decide on how best to handle it. I&rsquo;d like to avoid writing my
own comment system and requiring potential commenters to sign up for yet
another account. (I&rsquo;d use Persona for commenter identification and
authentication just as I do for the admin login, but very few people currently
have Persona accounts or even know what it is.) I like Disqus, but I&rsquo;m not
sure it would integrate well with the minimalist interface I&rsquo;ve designed.</li>
<li><strong>Geotagging and maps.</strong> I&rsquo;m already reading GPS data from EXIF tags where
available, but now I need to do something with it. I&rsquo;d like to add the ability
to manually add locations to photos and albums, and to have a map that shows
where photos were taken.</li>
</ul>


<p>Those five items represent maybe a quarter to a third of the work I still have
planned, so to repeat myself again, there&rsquo;s a lot of work to do. But I&rsquo;m very
happy with the progress I&rsquo;ve made so far, and I feel confident that I can get
this finished. It&rsquo;s just a matter of when.</p>
</div>

</div>

  <footer>
    <p class="meta">
      








  


<time datetime="2012-11-14T22:58:00-08:00" pubdate data-updated="true">Nov 14<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/categories/coding/'>Coding</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/entry/2012/10/03/why-mozilla-persona-is-the-right-answer-to-the-question-of-identity/" title="Previous Post: Why Mozilla Persona Is the Right Answer to the Question of Identity">&laquo; Why Mozilla Persona Is the Right Answer to the Question of Identity</a>
      
      
        <a class="basic-alignment right" href="/entry/2013/06/09/the-subaru-saga/" title="Next Post: The Subaru Saga">The Subaru Saga &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1><a name="comments">Comments</a></h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
<h1>Pages</h1>
<ul id="pages-aside">
<li><a href="/" title="Home">Home</a></li>
<li><a href="/about" title="About">About</a></li>
<li><a href="/blog/archives" title="Archives">Archives</a></li>
<li><a href="/projects" title="Projects">Projects</a></li>
</ul>

</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      
      <li class="post             category-Gaming            ">
        <a href="/entry/2014/05/18/the-elder-scrolls-online/">The Elder Scrolls Online</a>
      </li>
    
      
      <li class="post             category-Personal            ">
        <a href="/entry/2013/12/24/road-trip/">Road Trip! Part II</a>
      </li>
    
      
      <li class="post             category-Personal            ">
        <a href="/entry/2013/07/30/road-trip/">Road Trip! Part I</a>
      </li>
    
      
      <li class="post             category-Personal            ">
        <a href="/entry/2013/06/09/the-subaru-saga/">The Subaru Saga</a>
      </li>
    
      
      <li class="post             category-Coding            ">
        <a href="/entry/2012/11/14/photo-app-progress-update/">Photo App Progress Update</a>
      </li>
    
  </ul>
</section>



<section>
<h1>Categories</h1>
  <ul id="categories-aside">
  
  
    
  <li class="category-aside category-Coding">
    <a href="/categories/coding">Coding</a>
  </li>
  
    
  <li class="category-aside category-Gaming">
    <a href="/categories/gaming">Gaming</a>
  </li>
  
    
  <li class="category-aside category-Links">
    <a href="/categories/links">Links</a>
  </li>
  
    
  <li class="category-aside category-Personal">
    <a href="/categories/personal">Personal</a>
  </li>
  
    
  <li class="category-aside category-Technology">
    <a href="/categories/technology">Technology</a>
  </li>
  
  </ul>
</section>
<section>
<h1>Social</h1>
<ul id="social-aside">
<li>
<a rel="me" target="_blank" href="https://github.com/mlindgren"
title="Visit my Github public repositories."><img src="/images/github.png"
alt="Click to visit Github">&nbsp;Github</a></li>
<li>
<a rel="me" target="_blank"
href="http://www.last.fm/user/lindgrenM" title="Visit my last.fm profile
page."><img src="/images/last.fm.png" alt="Click to visit
last.fm">&nbsp;last.fm</a>
</li>
<li>
<a rel="me" target="_blank"
href="http://stackoverflow.com/users/108340/mitch-lindgren" title="Visit my
Stack Overflow profile."><img src="/images/stackoverflow.png" alt="Click to
visit Stack Overflow">&nbsp;Stack Overflow</a>
</li>
<li>
<a rel="me"
target="_blank" href="https://twitter.com/lindgrenM" title="Follow @lindgrenM on
Twitter"><img src="/images/twitter.png" alt="Click to visit
Twitter">&nbsp;Twitter</a>
</li>
<li><a rel="me" target="_blank"
href="http://mlindgren.yelp.ca/" title="Read my business reviews on Yelp."><img
src="/images/yelp.png" alt="Click to visit Yelp">&nbsp;Yelp</a>
</li>
<li>
<a
rel="me" target="_blank" href="http://www.youtube.com/user/lindgrenMitch"
title="Visit my YouTube channel."><img src="/images/yt.png"
alt="Click to visit YouTube">&nbsp;YouTube</a>
</li>
</ul>

</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/mlindgren">@mlindgren</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'mlindgren',
            count: 3,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><ul class="subscription" data-subscription="rss"
style="float: right; display: inline-block;">
<li style="display: inline-block;"><a href="/atom.xml" rel="subscribe-rss"
title="subscribe via RSS"
style="font-size: 18px; width: 22px; height: 22px; display: inline-block;
overflow: hidden">
RSS</a>
</li>
</ul>

<p>
  Copyright &copy; 2010 - 2014 Mitch Lindgren
  <a rel="license"
     href="http://creativecommons.org/licenses/by-nc-sa/3.0/deed.en_US"><img
     alt="Creative Commons License" style="border-width:0"
     src="http://i.creativecommons.org/l/by-nc-sa/3.0/80x15.png" /></a>

  <span class="credit"
        style="text-align: center; position: absolute; left: 50%">
  Powered by <a href="http://octopress.org">Octopress</a>
  </span>
</p>

<script type="text/javascript">
document.body.className += " " + navigator.platform;
</script>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mlindgrenca';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.mlindgren.ca/entry/2012/11/14/photo-app-progress-update/';
        var disqus_url = 'http://blog.mlindgren.ca/entry/2012/11/14/photo-app-progress-update/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
